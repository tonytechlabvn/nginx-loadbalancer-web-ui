pipeline {
    agent any
    
    environment {
        // Harbor Domain registry
        HARBOR_DOMAIN_NAME = "harbor.tonytechlab.com"
        
        // Image path on the registry
        APP_IMAGE_NAME = "harbor.tonytechlab.com/template-nlb/nginx-loadbalancer-tool"

        // Credentials IDs (Đảm bảo ID này đã tồn tại trong Jenkins)
        REGISTRY_LOGIN_ID = 'harbor-registry-login'

        // Updated namespace to be correct
        K8S_NAMESPACE = 'nlb-tool'
    }

    stages {
        stage('Stage 1: Checkout Latest Code') {
            steps {
                echo 'Starting to check out code...'
                cleanWs()
                checkout scm
                echo "SUCCESS: Code checkout complete."
            }
        }

        stage('Stage 2: Build & Push App') { 
            steps {
                echo "INFO: Logging into Registry..."
                withCredentials([usernamePassword(credentialsId: REGISTRY_LOGIN_ID, usernameVariable: 'REG_USER', passwordVariable: 'REG_PASS')]) {
                    sh "docker login ${HARBOR_DOMAIN_NAME} -u ${REG_USER} -p ${REG_PASS}"
                }
                
                echo "INFO: Building App image..."
                // Lưu ý: Đảm bảo file 'Dockerfile.txt' tồn tại, nếu không hãy đổi thành 'Dockerfile'
                sh "docker build -f Dockerfile.txt -t ${APP_IMAGE_NAME}:latest ."
                
                echo "INFO: Pushing App image..."
                sh "docker push ${APP_IMAGE_NAME}:latest"

                echo "INFO: Logging out from Registry..."
                sh "docker logout ${HARBOR_DOMAIN_NAME}"
            }
        }
        
        stage('Stage 3: Auto-Assemble & Push Helm Chart') { 
            steps {
                echo "INFO: Logging into Registry..."
                withCredentials([usernamePassword(credentialsId: REGISTRY_LOGIN_ID, usernameVariable: 'REG_USER', passwordVariable: 'REG_PASS')]) {
                     sh 'echo $REG_PASS | helm registry login ${HARBOR_DOMAIN_NAME} -u $REG_USER --password-stdin'
                }
                
                script {
                    def chartName = "template-nlb"
                    
                    // 1. Tạo môi trường sạch
                    sh "rm -rf build_area && mkdir build_area"
                    
                    dir('build_area') {
                        // 2. Tạo khung Chart chuẩn (Sinh ra values.yaml mặc định)
                        sh "helm create ${chartName}"

                        // 3. Dọn dẹp folder templates (Xóa deployment/service mẫu)
                        sh "rm -rf ${chartName}/templates/*"
                        
                        // ====================================================
                        // QUAN TRỌNG: XỬ LÝ VALUES.YAML
                        // ====================================================
                        echo "INFO: Overwriting default values.yaml with User config..."
                        
                        // Lệnh này copy file values.yaml của Tony đè lên file values.yaml vừa được tạo
                        // -f (force): Bắt buộc ghi đè không cần hỏi
                        // Vị trí đích: ${chartName}/values.yaml (Nằm ngay root chart)
                        sh "cp -f ../helm/values.yaml ${chartName}/values.yaml"
                        
                        // ====================================================
                        // XỬ LÝ CÁC FILE TEMPLATE KHÁC (Deployment, Service...)
                        // ====================================================
                        echo "INFO: Copying other YAML files to templates folder..."
                        
                        // Logic: Tìm tất cả file .yaml trong git
                        // NHƯNG LOẠI TRỪ (! -name) file values.yaml vì đã copy ở trên rồi
                        // Copy tất cả vào folder 'templates/'
                        sh """
                            find ../helm -maxdepth 1 -name "*.yaml" ! -name "values.yaml" ! -name "*.tgz" -exec cp {} ${chartName}/templates/ \\;
                        """
                        
                        // Debug: In ra nội dung file values.yaml sau khi copy để Tony kiểm tra trong log
                        echo "--- CHECK CONTENT OF VALUES.YAML ---"
                        sh "cat ${chartName}/values.yaml"

                        // 4. ĐÓNG GÓI
                        def chartVersion = "0.1.${env.BUILD_NUMBER}"
                        sh "helm package ${chartName} --version ${chartVersion} --app-version latest"
                        
                        // 5. PUSH
                        sh "helm push ${chartName}-${chartVersion}.tgz oci://${HARBOR_DOMAIN_NAME}/template-nlb"
                    }
                }
                
                sh "helm registry logout ${HARBOR_DOMAIN_NAME}"
            }
        }

    } // End of stages
    
    post {
        always {
            echo 'Pipeline has finished (Regardless of success or failure).'
        }
        success {
            echo '✅ SUCCESS: Pipeline completed successfully!'
        }
        failure {
            echo '❌ FAILED: Pipeline failed.'
        }
    } // End of post
}